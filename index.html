<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Global Collaborative Map</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <!-- MarkerCluster CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"
    />
    <style>
      /* Basic Page & Map Styling */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }
      #map {
        height: 100vh;
        width: 100%;
      }
      /* Remove default background for Leaflet divIcon */
      .leaflet-div-icon {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
      }
      /* Search Container & Results */
      #searchContainer {
        position: absolute;
        top: 10px;
        left: 2cm;
        z-index: 10001;
        width: calc(250px - 1cm);
      }
      #searchBar {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
      }
      #searchResults {
        list-style: none;
        margin: 0;
        padding: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-height: 150px;
        overflow-y: auto;
        display: none;
      }
      #searchResults li {
        padding: 5px;
        cursor: pointer;
      }
      #searchResults li:hover {
        background: #f0f0f0;
      }
      /* Pin List Menu */
      #pinListMenu {
        position: absolute;
        top: 3.5cm;
        left: 0.5cm;
        width: 7cm;
        height: 15cm;
        background: #fff;
        border: 1px solid #ccc;
        overflow-y: auto;
        z-index: 10000;
        padding: 5px;
        font-size: 14px;
      }
      #pinListMenu strong {
        font-weight: normal;
      }
      /* Modal for Custom Pin Form */
      #pinFormModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #pinFormModal .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        width: 320px;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        transition: all 0.3s ease-in-out;
      }
      #pinFormModal label {
        font-weight: bold;
      }
      #pinFormModal input[type="text"],
      #pinFormModal textarea {
        width: 100%;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      /* Icon Custom Options Layout */
      #iconCustomOptions {
        display: flex;
        flex-direction: row;
        margin-bottom: 10px;
      }
      #shapeSelection {
        padding-right: 5px;
        border-right: 1px solid #ccc;
      }
      .shape-option {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
        cursor: pointer;
        border: 1px solid #ccc;
      }
      #colorSelection {
        padding: 0 5px;
        border-right: 1px solid #ccc;
      }
      #colorSelection table {
        border-collapse: collapse;
      }
      #colorSelection td {
        padding: 0;
        margin: 0;
      }
      .color-option {
        width: 15px;
        height: 15px;
        cursor: pointer;
        border: 1px solid #ccc;
        display: inline-block;
      }
      #iconPreview {
        padding-left: 5px;
      }
      #previewWindow {
        width: 100px;
        height: 100px;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .selected {
        border-color: orange !important;
      }
      /* Enhanced Marker styling */
      .custom-marker {
        font-size: 10px;
        font-weight: bold;
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .custom-marker:hover {
        transform: scale(1.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }
      /* Tooltip styling */
      .custom-tooltip {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 5px;
        border-radius: 3px;
        font-size: 12px;
      }
      /* Context Menu Styling */
      .custom-context-menu {
        text-align: center;
        font-size: 14px;
      }
      .custom-context-menu a {
        display: block;
        padding: 6px 10px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }
      .custom-context-menu a:last-child {
        border-bottom: none;
      }
      .custom-context-menu a:hover {
        background-color: #f9f9f9;
        color: #000;
      }
    </style>
  </head>
  <body>
    <!-- Pin List Menu -->
    <div id="pinListMenu"></div>
    <!-- Search Container -->
    <div id="searchContainer">
      <input
        type="text"
        id="searchBar"
        placeholder="Search location..."
      />
      <ul id="searchResults"></ul>
    </div>
    <!-- Map Container -->
    <div id="map"></div>
    <!-- Modal for Custom Pin Form -->
    <div id="pinFormModal">
      <div class="modal-content">
        <h3 id="modalHeader">Add Custom Pin</h3>
        <label for="pinTitle">Title:</label>
        <input
          type="text"
          id="pinTitle"
          placeholder="Enter title"
          required
        />
        <label for="pinNumber">Number (optional):</label>
        <input
          type="text"
          id="pinNumber"
          placeholder="Enter number"
        />
        <label for="pinDescription">Details:</label>
        <textarea
          id="pinDescription"
          placeholder="Enter details"
        ></textarea>
        <!-- Icon Custom Options Layout -->
        <div id="iconCustomOptions">
          <div id="shapeSelection">
            <div class="shape-option" data-shape="square">
              <div
                style="width:30px; height:30px; border:1px solid gray;"
              ></div>
            </div>
            <div class="shape-option" data-shape="circle">
              <div
                style="width:30px; height:30px; border:1px solid gray; border-radius:50%;"
              ></div>
            </div>
          </div>
          <div id="colorSelection">
            <!-- Color palette will be generated here -->
          </div>
          <div id="iconPreview">
            <div id="previewWindow"></div>
          </div>
        </div>
        <button id="savePinBtn">Save</button>
        <button id="cancelPinBtn">Cancel</button>
      </div>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"></script>
    <!-- Leaflet and MarkerCluster -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
      // Initialize Firebase with your project credentials.
      // Replace the placeholders below with your actual config values.
      const firebaseConfig = {
        apiKey: "AIzaSyDV4B8Ndpl8qQX6Ou9k2ys9Gif8HNb24QE",
        authDomain: "nts-air.firebaseapp.com",
        databaseURL:
          "https://nts-air-default-rtdb.firebaseio.com",
        projectId: "nts-air",
        storageBucket: "nts-air.appspot.com",
        messagingSenderId: "690931555767",
        appId: "1:690931555767:web:506a87b24fad77653f1c32"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Global Variables
      let customPins = [];             // Array to hold pin data
      let customPinMarkers = {};       // Object to store markers by pin ID
      let currentEditingPinId = null;  // For tracking which pin is being edited
      let currentPinLatLng = null;     // The location for the new pin
      let selectedShape = "circle";    // Default icon shape
      let selectedColor = "blue";      // Default icon color

      // Initialize Map using Leaflet
      const map = L.map("map", {
        center: [45.541, 10.211],
        zoom: 7
      });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Map data Â© OpenStreetMap contributors"
      }).addTo(map);

      // Layer for custom (collaborative) pins
      const customPinLayer = L.layerGroup().addTo(map);

      // Create a marker icon with dynamic size and enhanced styling.
      function createMarkerIcon(iconData, pinNumber) {
        const baseSize = 20;
        const zoomDiff = map.getZoom() - 13;
        const factor = 1.0366;
        const size = baseSize * Math.pow(factor, zoomDiff);
        const lighter = lightenColor(iconData.color, 20);
        const darker = darkenColor(iconData.color, 20);
        let inlineStyle =
          "background: " + iconData.color + "; " +
          "background-image: linear-gradient(135deg, " + lighter + ", " + darker + "); " +
          "width:" + size + "px; " +
          "height:" + size + "px; " +
          "line-height:" + size + "px; " +
          "text-align: center;";
        if (iconData.shape === "circle") {
          inlineStyle += "border-radius:" + (size / 2) + "px;";
        }
        const htmlContent =
          '<div class="custom-marker" style="' +
          inlineStyle +
          '">' +
          (pinNumber || "") +
          "</div>";
        return L.divIcon({
          html: htmlContent,
          iconSize: [size, size],
          iconAnchor: [size / 2, size]
        });
      }

      function parseIconValue(value) {
        const parts = value.split("-");
        return { color: parts[0], shape: parts[1] };
      }

      // Create and add a marker for a given pin
      function createPinMarker(pin) {
        const iconData = parseIconValue(pin.icon);
        if (iconData.shape === "triangle") {
          iconData.shape = "circle";
        }
        const divIcon = createMarkerIcon(iconData, pin.number);
        const marker = L.marker([pin.lat, pin.lng], {
          icon: divIcon,
          draggable: true
        });

        // Store pin data on marker for reference
        marker.pinData = pin;

        // When marker is dragged, update the pin's location in Firebase.
        marker.on("dragend", function(e) {
          const newLatLng = e.target.getLatLng();
          firebase.database().ref("pins/" + pin.id).update({
            lat: newLatLng.lat,
            lng: newLatLng.lng
          });
        });

        // Toggle tooltip on click.
        marker.on("click", function() {
          togglePinTooltip(pin.id);
        });

        // Right-click to show context menu (Edit/Delete).
        marker.on("contextmenu", function(e) {
          e.originalEvent.preventDefault();
          showContextMenu(pin.id, e.latlng);
        });

        // Bind tooltip if the pin is set to display one.
        if (pin.tooltipOpened) {
          const infoHtml =
            '<div style="text-align:left;"><strong>' +
            pin.title +
            '</strong><br/>' +
            pin.description +
            "</div>";
          marker.bindTooltip(infoHtml, {
            permanent: true,
            direction: "right",
            offset: L.point(3, 5),
            className: "custom-tooltip"
          });
          marker.infoVisible = true;
          marker.originalTooltipContent = infoHtml;
        } else {
          marker.infoVisible = false;
        }

        customPinMarkers[pin.id] = marker;
        customPinLayer.addLayer(marker);
      }

      // Update the pin list menu (sorted display of pins)
      function updatePinListMenu() {
        const menu = document.getElementById("pinListMenu");
        let sortedPins = customPins.slice().sort(function(a, b) {
          let aNum = parseFloat(a.number), bNum = parseFloat(b.number);
          if (!isNaN(aNum) && !isNaN(bNum)) {
            if (aNum !== bNum) return aNum - bNum;
          } else {
            if (a.number < b.number) return -1;
            if (a.number > b.number) return 1;
          }
          if (a.title < b.title) return -1;
          if (a.title > b.title) return 1;
          if (a.description < b.description) return -1;
          if (a.description > b.description) return 1;
          return 0;
        });

        let html = "<ul style='list-style:none; padding:0; margin:0;'>";
        sortedPins.forEach(function(pin) {
          let textDecoration = pin.tooltipOpened ? "none" : "line-through";
          let iconData = parseIconValue(pin.icon);
          html += "<li style='padding:2px 0; border-bottom:1px solid #ccc; text-decoration:" +
          textDecoration + ";'>";
          html += "<span style='display: inline-block; background:" +
          iconData.color +
          "; width: 15px; height: 15px; margin-right: 5px;";
          if (iconData.shape === "circle") {
            html += "border-radius:50%;";
          }
          html += "'></span>";
          html += "<span>" +
          (pin.number ? pin.number + " " : "") +
          pin.title +
          " - " +
          pin.description +
          "</span>";
          html += "</li>";
        });
        html += "</ul>";
        menu.innerHTML = html;
      }

      // Toggle a pin's tooltip visibility and update Firebase.
      function togglePinTooltip(pinId) {
        const marker = customPinMarkers[pinId];
        if (!marker) return;
        const pin = customPins.find(function(p) {
          return p.id === pinId;
        });
        if (!pin) return;

        if (marker.infoVisible) {
          marker.unbindTooltip();
          marker.infoVisible = false;
          pin.tooltipOpened = false;
          firebase.database().ref("pins/" + pinId).update({ tooltipOpened: false });
        } else {
          const infoHtml =
            '<div style="text-align:left;"><strong>' +
            pin.title +
            '</strong><br/>' +
            pin.description +
            "</div>";
          marker.bindTooltip(infoHtml, {
            permanent: true,
            direction: "right",
            offset: L.point(3, 5),
            className: "custom-tooltip"
          });
          marker.infoVisible = true;
          pin.tooltipOpened = true;
          marker.originalTooltipContent = infoHtml;
          firebase.database().ref("pins/" + pinId).update({ tooltipOpened: true });
        }
        updatePinListMenu();
      }

      // Show a context menu for editing or deleting a pin.
      function showContextMenu(pinId, latlng) {
        const popup = L.popup({ offset: L.point(0, -30) })
          .setLatLng(latlng)
          .setContent(
            '<div class="custom-context-menu">' +
              '<a href="#" onclick="editPin(\'' + pinId + '\'); return false;">Edit</a>' +
              '<a href="#" onclick="deletePin(\'' + pinId + '\'); return false;">Delete</a>' +
            "</div>"
          );
        popup.openOn(map);
      }

      // Delete a pin via Firebase.
      function deletePin(pinId) {
        firebase.database().ref("pins/" + pinId).remove()
          .then(() => { console.log("Pin deleted successfully."); })
          .catch((error) => { console.error("Error deleting pin:", error); });
      }

      // Edit a pin: populate the form with its data and load the color palette.
      window.editPin = function(pinId) {
        const pin = customPins.find(function(item) { return item.id === pinId; });
        if (pin) {
          currentEditingPinId = pinId;
          document.getElementById("modalHeader").textContent = "Edit Custom Pin";
          document.getElementById("pinTitle").value = pin.title;
          document.getElementById("pinNumber").value = pin.number;
          document.getElementById("pinDescription").value = pin.description;
          const parts = pin.icon.split("-");
          updateSelectedIconChoices(parts[1], parts[0]);
          // Load the color palette so the appearance can be changed.
          const tableHTML = generateColorTable();
          document.getElementById("colorSelection").innerHTML = tableHTML;
          document.querySelectorAll("#colorSelection .color-option").forEach(function(el) {
            el.addEventListener("click", function() {
              const c = this.getAttribute("data-color");
              updateSelectedIconChoices(selectedShape, c);
            });
          });
          document.getElementById("pinFormModal").style.display = "flex";
        }
      }

      // Update the icon preview in the form.
      function updatePreview() {
        const previewWindow = document.getElementById("previewWindow");
        const lighter = lightenColor(selectedColor, 20);
        const darker = darkenColor(selectedColor, 20);
        let style =
          "background: " + selectedColor + "; " +
          "background-image: linear-gradient(135deg, " + lighter + ", " + darker + "); " +
          "width:100px; height:100px; line-height:100px;";
        if (selectedShape === "circle") {
          style += "border-radius:50%;";
        }
        previewWindow.innerHTML =
          '<div class="custom-marker" style="' + style + '"></div>';
      }

      // Update the selected icon choices (shape and color)
      function updateSelectedIconChoices(shape, color) {
        document.querySelectorAll("#shapeSelection .shape-option").forEach(function(el) {
          el.classList.remove("selected");
          if (el.getAttribute("data-shape") === shape) {
            el.classList.add("selected");
          }
        });
        document.querySelectorAll("#colorSelection .color-option").forEach(function(el) {
          el.classList.remove("selected");
          if (el.getAttribute("data-color") === color) {
            el.classList.add("selected");
          }
        });
        selectedShape = shape;
        selectedColor = color;
        updatePreview();
      }

      // Attach click events to shape options.
      document.querySelectorAll("#shapeSelection .shape-option").forEach(function(el) {
        el.addEventListener("click", function() {
          const shape = this.getAttribute("data-shape");
          updateSelectedIconChoices(shape, selectedColor);
        });
      });

      // Helper: Convert HSL to HEX.
      function hslToHex(h, s, l) {
        s /= 100;
        l /= 100;
        const c = (1 - Math.abs(2 * l - 1)) * s;
        const x = c * (1 - Math.abs((h / 60) % 2 - 1));
        const m = l - c / 2;
        let r = 0,
          g = 0,
          b = 0;
        if (0 <= h && h < 60) { r = c; g = x; b = 0; }
        else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
        else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
        else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
        else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
        else if (300 <= h && h < 360) { r = c; g = 0; b = x; }
        r = Math.round((r + m) * 255);
        g = Math.round((g + m) * 255);
        b = Math.round((b + m) * 255);
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
      }

      // Generate the color palette table.
      function generateColorTable() {
        const totalCells = 5 * 9;
        let html = "<table>";
        for (let i = 0; i < 5; i++) {
          html += "<tr>";
          for (let j = 0; j < 9; j++) {
            const index = i * 9 + j;
            const hue = (index * 360) / totalCells;
            const color = hslToHex(hue, 100, 50);
            html +=
              "<td><div class='color-option' data-color='" +
              color +
              "' style='width:15px; height:15px; background:" +
              color +
              "; border:1px solid #ccc;'></div></td>";
          }
          html += "</tr>";
        }
        html += "</table>";
        return html;
      }

      // Show the pin form for adding a new pin.
      function showPinForm() {
        document.getElementById("pinFormModal").style.display = "flex";
        document.getElementById("pinTitle").value = "";
        document.getElementById("pinNumber").value = "";
        document.getElementById("pinDescription").value = "";
        // Reset default appearance
        updateSelectedIconChoices("circle", "blue");
        const tableHTML = generateColorTable();
        document.getElementById("colorSelection").innerHTML = tableHTML;
        document
          .querySelectorAll("#colorSelection .color-option")
          .forEach(function(el) {
            el.addEventListener("click", function() {
              const c = this.getAttribute("data-color");
              updateSelectedIconChoices(selectedShape, c);
            });
          });
      }

      // Hide the pin form.
      function hidePinForm() {
        document.getElementById("pinFormModal").style.display = "none";
      }

      // Save (or update) a pin via Firebase.
      document
        .getElementById("savePinBtn")
        .addEventListener("click", function() {
          const title = document.getElementById("pinTitle").value.trim();
          const number = document.getElementById("pinNumber").value.trim();
          const description = document
            .getElementById("pinDescription")
            .value.trim();
          if (!title) {
            alert("Title is required!");
            return;
          }
          const iconType = selectedColor + "-" + selectedShape;
          if (currentEditingPinId) {
            // Update existing pin.
            firebase.database().ref("pins/" + currentEditingPinId).update({
              title: title,
              number: number,
              description: description,
              icon: iconType
            })
            .then(() => {
              console.log("Pin updated successfully.");
            })
            .catch((error) => {
              console.error("Error updating pin: ", error);
            });
            currentEditingPinId = null;
          } else {
            // Ensure the map was right-clicked to set a location.
            if (!currentPinLatLng) {
              alert("Please right-click on the map to set a location for the pin.");
              return;
            }
            const pinObj = {
              title: title,
              number: number,
              description: description,
              icon: iconType,
              tooltipOpened: true,
              lat: currentPinLatLng.lat,
              lng: currentPinLatLng.lng
            };
            firebase.database().ref("pins").push(pinObj)
            .then(() => {
              console.log("Pin added successfully.");
            })
            .catch((error) => {
              console.error("Error adding pin: ", error);
            });
          }
          hidePinForm();
        });
  
      document
        .getElementById("cancelPinBtn")
        .addEventListener("click", function() {
          hidePinForm();
        });
  
      // Realtime listener: update pins when the "pins" node changes.
      firebase.database().ref("pins").on("value", (snapshot) => {
        // Clear existing markers and pin array.
        customPinLayer.clearLayers();
        customPins = [];
        customPinMarkers = {};
        const data = snapshot.val();
        if (data) {
          Object.keys(data).forEach((key) => {
            const pin = data[key];
            pin.id = key;
            customPins.push(pin);
            createPinMarker(pin);
          });
        }
        updatePinListMenu();
      });
  
      // Right-click on map to add a new pin.
      map.on("contextmenu", function(e) {
        currentPinLatLng = e.latlng;
        currentEditingPinId = null;
        document.getElementById("modalHeader").textContent = "Add Custom Pin";
        showPinForm();
      });
  
      // Update markers when zoom/move ends (to recalc sizes).
      map.on("zoomend moveend", function() {
        for (let key in customPinMarkers) {
          const marker = customPinMarkers[key];
          const pin = marker.pinData;
          const iconData = parseIconValue(pin.icon);
          if (iconData.shape === "triangle") {
            iconData.shape = "circle";
          }
          const newIcon = createMarkerIcon(iconData, pin.number);
          marker.setIcon(newIcon);
        }
      });
    </script>
  </body>
</html>
